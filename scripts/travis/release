#!/usr/bin/env bash

source ./scripts/main

set -x

if [[ "${CHANNEL:-}" == "" ]]; then
  if [[ "${TRAVIS_TAG:-}" != "" ]]; then
    export CHANNEL=stable
  elif [[ "${TRAVIS_BRANCH:-}" = "master" ]]; then
    export CHANNEL=beta
  elif [[ "${TRAVIS_BRANCH:-}" = "dev" ]]; then
    export CHANNEL=dev
  elif [[ "${TRAVIS_BRANCH:-}" = "macos-installer" ]]; then
    export CHANNEL=dev
  fi
fi

if [[ -z "${CHANNEL:-}" ]]; then
  echo "Not releasing on this branch."
  exit 0
fi

echo "Releasing ${CHANNEL}"

"${root}/scripts/darwin/build"

REMOTE_BASE="s3://$S3_BUCKET/heroku-cli/channels/$CHANNEL"
s3uploadHourCache "${root}/tmp/heroku-cli.pkg" "${REMOTE_BASE}/heroku-cli.pkg"
