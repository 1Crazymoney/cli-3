#!/usr/bin/env bash

source ./scripts/main

set -x

echo "Releasing ${CHANNEL}"

# first build the base
"${root}/scripts/build_base" tmp/heroku

# now build the installers and tarballs in parallel
bg "${root}/scripts/build_tarballs" tmp/heroku dist/tarballs
if [[ "${OS}" = "windows" ]]; then
  bg "${root}/scripts/windows/release"
fi
wait_all

# finally, release to s3
"${root}/scripts/release_tarballs" dist/tarballs

# invalidate CDN
aws cloudfront create-invalidation --distribution-id EHF9FOCUJYVZ --paths "/heroku-cli/channels/$CHANNEL/*"
