#!/usr/bin/env bash

set +x

echo "$HEROKU_WINDOWS_KEY" | base64 --decode > /tmp/heroku-windows-key

source ./scripts/_init

set -x

# setup workspace
INSTALLER_BASE=$tmp/windows-$ARCH-installer
rm -rf "$INSTALLER_BASE"
mkdir -p "$INSTALLER_BASE/bin"

cp "$root/resources/exe/heroku.cmd" "$INSTALLER_BASE/bin/heroku.cmd"

mv "$(workspace_dir)" "$INSTALLER_BASE/client"

if [ "$ARCH" == "x64" ]; then
  PROGRAMSUFFIX="64"
else
  PROGRAMSUFFIX=""
fi

sed -e "s/!define Version 'VERSION'/!define Version '${VERSION}'/" resources/exe/heroku.nsi |\
  sed -e "s/InstallDir .*/InstallDir \"\$PROGRAMFILES$PROGRAMSUFFIX\\\Heroku\"/" \
  > "$INSTALLER_BASE/heroku.nsi"

makensis "$INSTALLER_BASE/heroku.nsi" | grep -v "[compress]"

set +x
osslsigncode -pkcs12 /tmp/heroku-windows-key \
  -pass "$HEROKU_WINDOWS_SIGNING_PASS" \
  -n 'Heroku CLI' \
  -i https://toolbelt.heroku.com/ \
  -in "$INSTALLER_BASE/installer.exe" -out "$dist/heroku-cli-$ARCH.exe"
