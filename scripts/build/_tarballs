#!/usr/bin/env bash

source ./scripts/_init

set -x

# create tarballs
cd "$(platform_dir)"
o="$(dist_dir)"
mkdir -p "$o"

# must be a directory in this format
# but it is difficult to work with the version number in other places
mv "$(workspace_dir)" "$(versioned_base)"

bg tar c "$(versioned_base)" | xz > "$(txz_path)"
bg tar czf "$(tgz_path)" "$(versioned_base)"
wait_all

mv "$(versioned_base)" "$(workspace_base)"

sha256=$(shasum -a 256 "$(tgz_path)" | awk \{'print $1'\})
sha256xz=$(shasum -a 256 "$(txz_path)" | awk \{'print $1'\})
cat << EOF > "$o/${OS}-${ARCH}"
{
  "channel": "${CHANNEL}",
  "version": "${VERSION}",
  "sha256gz": "${sha256}",
  "sha256xz": "${sha256xz}"
}
EOF
