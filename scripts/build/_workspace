#!/usr/bin/env bash

# builds a directory structure of a CLI to be released
# this is the starting point for any build
# It includes:
#
# * node binary
# * node modules
# * bin scripts

source ./scripts/_init

set -x

# setup workspace
o="$(workspace_dir)"
rm -rf "${o}"
mkdir -p "${o}/node_modules"
mkdir -p "${o}/bin"
cp "${root}/README.md" "${o}"
cp "${root}/LICENSE" "${o}"
cp "${root}/package.json" "${o}"
cp "${root}/yarn.lock" "${o}"

cp -rv "${root}/lib" "${o}/lib"

(
  cd "${o}"
  # install packages
  yarn install --no-progress --production --non-interactive --mutex=file:/tmp/.yarn-mutex
)

"${root}/scripts/build/_fetch_node_binary" "${o}/bin"

# build cli-engine if needed
if [ ! -f "${o}/node_modules/cli-engine/lib/cli.js" ]; then
  cd "${o}/node_modules/cli-engine"
  yarn
  yarn run prepare
fi

# create bin runner
if [ "${OS}" == "windows" ]; then
  cat << EOF > "${o}/bin/heroku.cmd"
@echo off
set CLI_BINPATH=%~dp0\\heroku.cmd
"%~dp0\\node.exe" "%~dp0\\heroku.js" %*
EOF
else
  cat << EOF > "${o}/bin/heroku"
#!/usr/bin/env bash
set -e
get_script_dir () {
  SOURCE="\${BASH_SOURCE[0]}"
  # While \$SOURCE is a symlink, resolve it
  while [ -h "\$SOURCE" ]; do
    DIR="\$( cd -P "\$( dirname "\$SOURCE" )" && pwd )"
    SOURCE="\$( readlink "\$SOURCE" )"
    # If \$SOURCE was a relative symlink (so no "/" as prefix, need to resolve it relative to the symlink base directory
    [[ \$SOURCE != /* ]] && SOURCE="\$DIR/\$SOURCE"
  done
  DIR="\$( cd -P "\$( dirname "\$SOURCE" )" && pwd )"
  echo "\$DIR"
}
DIR=\$(get_script_dir)
# normalize home directory
CLI_HOME=\$(cd && pwd)
XDG_DATA_HOME=\${XDG_DATA_HOME:="\$CLI_HOME/.local/share"}
BIN_DIR="\$XDG_DATA_HOME/heroku/client/bin"
if [ -x "\$BIN_DIR/heroku" ] && [ ! "\$BIN_DIR" -ef "\$DIR" ]; then
  "\$XDG_DATA_HOME/heroku/client/bin/heroku" "\$@"
else
  CLI_BINPATH="\$DIR/heroku" "\$DIR/node" "\$DIR/heroku.js" "\$@"
fi
EOF
chmod +x "${o}/bin/heroku"
fi

cat << EOF > "${o}/bin/heroku.js"
const {run} = require('cli-engine')
const config = {
  channel: '${CHANNEL}',
  version: '${VERSION}'
}
run({config})
EOF
