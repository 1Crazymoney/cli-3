#!/usr/bin/env bash

# shellcheck disable=SC2034

# fail wait when any children fails
set -m

set -o errexit
set -o pipefail
set -o nounset
# set -o xtrace

# Set magic variables for current file & dir
dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
root="$(cd "$(dirname "${dir}")" && pwd)"
scripts="$root/scripts"
tmp="$root/tmp"

CHANNEL=$(./scripts/_vars/_channel)
VERSION=$(./scripts/_vars/_version)

PLATFORMS=(
  windows_x86
  windows_x64
  darwin_x64
  linux_x86
  linux_x64
  linux_arm
)


function split_platform () {
  IFS='_' read -ra _platform <<< "$1"
  export OS=${_platform[0]}
  export ARCH=${_platform[1]}
}

if [[ ! -z "${CIRCLE_JOB-}" ]]; then
  split_platform "$CIRCLE_JOB"
fi

function versioned_base () {
  echo "heroku-cli-v${VERSION}-${OS}-${ARCH}"
}
function unversioned_base () {
  echo "heroku-cli-${OS}-${ARCH}"
}

function platform_dir () {
  echo "$tmp/${OS}_${ARCH}"
}

function workspace_dir () {
  echo "$(platform_dir)/workspace"
}

function dist_dir () {
  echo "$(platform_dir)/dist"
}

function tgz_path () {
  echo "$(dist_dir)/$(unversioned_base).tar.gz"
}
function txz_path () {
  echo "$(dist_dir)/$(unversioned_base).tar.xz"
}

function go_home () {
  cd "${root}"
}
go_home

function bg () {
  "$@" &
  pids="${pids:-} $!"
}

function wait_all () {
  for pid in $pids; do
    wait "${pid}" || exit 1
  done
}

REMOTE_BASE="s3://$S3_BUCKET/heroku-cli/channels/$CHANNEL"
function s3upload () {
  aws s3 cp "$@"
}
function s3uploadLongCache () {
  s3upload --cache-control max-age=86400 "$@"
}
function s3uploadShortCache () {
  s3upload --cache-control max-age=3600 "$@"
}
